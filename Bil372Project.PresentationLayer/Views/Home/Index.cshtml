@model Bil372Project.PresentationLayer.Models.DashboardViewModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery

@{
    Layout = "~/Views/Shared/_MainLayout.cshtml";
    ViewData["Title"] = "Gösterge Paneli";
}

<div class="glass-card mb-4">
    <div class="row g-4 align-items-center">
        <div class="col-lg-7">
            <h2 class="fw-bold mb-3">Merhaba! Bugün kendin için ne yapacaksın?</h2>
            <p class="text-muted mb-4"></p>
            <div class="d-flex flex-wrap gap-3">
                <a asp-action="Values" class="btn btn-primary btn-lg px-4">
                    <i class="bi bi-pencil-square me-2"></i> Değerlerimi Güncelle
                </a>
                <a asp-action="NewProgram" class="btn btn-outline-info btn-lg px-4">
                    <i class="bi bi-stars me-2"></i> Yeni Program Oluştur
                </a>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="position-relative p-4 rounded-4 text-white" style="background: linear-gradient(135deg,#30d0d0,#0575e6);">
                <h5 class="text-uppercase text-white-50">Günün İpucu</h5>
                <p class="fs-5 fw-semibold mb-4">
                    @(!string.IsNullOrWhiteSpace(Model.TipOfDay)
                        ? Model.TipOfDay
                        : "Su tüketimini takip et! Her saat başı bir bardak su içmek enerji seviyeni korumana yardımcı olur.")
                </p>                
                <span class="badge bg-white text-primary fw-semibold px-3 py-2">Hedef: 8 Bardak</span>
            </div>
        </div>
    </div>
</div>

@{
    var antiforgeryTokens = Antiforgery.GetAndStoreTokens(Context);
}

@section Scripts
{
    <script>
        (() => {
            const button = document.getElementById('water-increment-btn');
            const valueEl = document.getElementById('water-consumed-value');
            const statusEl = document.getElementById('water-increment-status');
            if (!button || !valueEl) return;

            const token = @System.Text.Json.JsonSerializer.Serialize(antiforgeryTokens.RequestToken);
            const endpoint = '@Url.Action("IncrementWater", "Home")';

            const setStatus = (text, isError = false) => {
                if (!statusEl) return;
                statusEl.textContent = text;
                statusEl.classList.toggle('text-danger', isError);
            };

            button.addEventListener('click', async () => {
                button.disabled = true;
                setStatus('Kaydediliyor...');

                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        body: '{}'
                    });

                    if (!response.ok) {
                        throw new Error();
                    }

                    const data = await response.json();
                    if (data && typeof data.waterConsumedToday === 'number') {
                        valueEl.textContent = data.waterConsumedToday;
                    }

                    setStatus('Güncellendi');
                } catch (error) {
                    setStatus('Kaydedilemedi. Lütfen hedef eklediğinden emin ol.', true);
                } finally {
                    setTimeout(() => setStatus(''), 1500);
                    button.disabled = false;
                }
            });
        })();
    </script>
}

<div class="stat-grid">
    <div class="stat-card">
        <h5>Güncel Kilo</h5>
        <span class="value">
            @if (Model.CurrentWeightKg.HasValue)
            {
                @Model.CurrentWeightKg.Value.ToString("0.0") <small class="fs-6">kg</small>
            }
            else
            {
                @:-
            }
        </span>

        @if (Model.WeightChangeLastMonthKg.HasValue)
        {
            var diff = Model.WeightChangeLastMonthKg.Value;
            if (diff < 0)
            {
                <span class="text-success fw-semibold">
                    <i class="bi bi-arrow-down-right me-1"></i>
                    Son ay @Math.Abs(diff).ToString("0.0") kg azaldı
                </span>
            }
            else if (diff > 0)
            {
                <span class="text-danger fw-semibold">
                    <i class="bi bi-arrow-up-right me-1"></i>
                    Son ay @diff.ToString("0.0") kg arttı
                </span>
            }
            else
            {
                <span class="text-muted fw-semibold">
                    Son ay kilon değişmedi
                </span>
            }
        }
        else
        {
            <span class="text-muted fw-semibold">
                Son ay için yeterli veri yok
            </span>
        }
    </div>

    <div class="stat-card">
        <h5>BMI</h5>
        <span class="value">
            @(Model.CurrentBmi.HasValue ? Model.CurrentBmi.Value.ToString("0.0") : "-")
        </span>
        <span class="text-muted">
            @(!string.IsNullOrEmpty(Model.BmiCategory) ? Model.BmiCategory : "Henüz hesaplanmadı")
        </span>
    </div>

    <div class="stat-card">
        <h5>Haftalık Aktivite</h5>
        <span class="value">@Model.WeeklyDietPlans <small class="fs-6">plan</small></span>
        <span class="text-muted">
            @(Model.WeeklyActivityTarget.HasValue
                ? $"Hedef: {Model.WeeklyActivityTarget} seans"
                : "Hedef henüz belirlenmedi")
        </span>
    </div>
    <div class="stat-card">
        <h5>Su Takibi</h5>
        <div class="d-flex align-items-center gap-2">
            <span class="value" id="water-consumed-value">@(Model.WaterConsumedToday ?? 0)</span>
            <button type="button" class="btn btn-sm btn-outline-primary" id="water-increment-btn" aria-label="Su tüketimini bir bardak artır">
                <i class="bi bi-arrow-up"></i>
            </button>
        </div>
        <div class="text-muted small mt-1" id="water-increment-status"></div>        
        <span class="text-muted">
            @(Model.DailyWaterTarget.HasValue
                ? $"Hedef: {Model.DailyWaterTarget} bardak"
                : "Su hedefini Hedef sayfasında ekleyebilirsin")
        </span>
    </div>
</div>

<div class="row g-4 mt-1">
    <div class="col-xl-7">
        <div class="glass-card h-100">
            <h4 class="section-title">Bugünkü Planın</h4>

            @if (Model.TodayPlan == null)
            {
                <p class="text-muted mt-3 mb-0">
                    Henüz bir beslenme programı oluşturmadın. 
                    <a asp-controller="Home" asp-action="NewProgram">Buradan yeni bir program oluşturabilirsin.</a>
                </p>
            }
            else
            {
                <table class="table-modern">
                    <thead>
                    <tr>
                        <th>Öğün</th>
                        <th>Öneri</th>
                        <th>Kalori</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td class="fw-semibold">Kahvaltı</td>
                        <td>@Model.TodayPlan.Breakfast</td>
                        <td>—</td> @* Şu an AI’dan kalori dönmediği için boş bırakıyoruz *@
                        <td><span class="badge-soft">Hazır</span></td>
                    </tr>
                    <tr>
                        <td class="fw-semibold">Öğle</td>
                        <td>@Model.TodayPlan.Lunch</td>
                        <td>—</td>
                        <td><span class="badge-soft">Hazır</span></td>
                    </tr>
                    <tr>
                        <td class="fw-semibold">Akşam</td>
                        <td>@Model.TodayPlan.Dinner</td>
                        <td>—</td>
                        <td><span class="badge-soft">Hazır</span></td>
                    </tr>
                    <tr>
                        <td class="fw-semibold">Ara Öğün</td>
                        <td>@Model.TodayPlan.Snack</td>
                        <td>—</td>
                        <td><span class="badge-soft">Hazır</span></td>
                    </tr>
                    </tbody>
                </table>

                <p class="text-muted small mb-0">
                    Oluşturulma zamanı: @Model.TodayPlan.GeneratedAt.ToLocalTime().ToString("dd MMM yyyy HH:mm")
                </p>
            }
        </div>
    </div>
    <div class="col-xl-5">
        <div class="glass-card h-100">
            <h4 class="section-title">Motivasyon</h4>
            <div class="program-step">
                <div class="step-index">1</div>
                <div>
                    <h6>Hedef kilon</h6>
                    <p class="text-muted small mb-0">
                        @(Model.TargetWeightKg.HasValue
                            ? $"Hedefin: {Model.TargetWeightKg:0.0} kg"
                            : "Henüz bir hedef kilo eklemedin")
                    </p>
                </div>
            </div>
            <div class="program-step">
                <div class="step-index">2</div>
                <div>
                    <h6>Beraber geçen haftalar</h6>
                    <p class="text-muted small mb-0">
                        @(Model.GoalDurationWeeks.HasValue
                            ? $"Bu yolculuk için {Model.GoalDurationWeeks} hafta planladık, birlikte başaracağız."
                            : "Süre hedefini belirlemek için Hedef sayfasına göz at.")
                    </p>
                </div>
            </div>
            <div class="program-step mb-0">
                <div class="step-index">3</div>
                <div>
                    <h6>Bugünkü notun</h6>
                    <p class="text-muted small mb-0">
                        @(!string.IsNullOrWhiteSpace(Model.MotivationNote)
                            ? Model.MotivationNote
                            : "Kendine küçük bir motivasyon cümlesi bırakmayı unutma.")
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
